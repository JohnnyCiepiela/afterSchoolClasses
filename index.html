<!DOCTYPE html>
<html lang="en">

<head>
    <!--Meta elements-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, inital-scale=1.0">
    <!--Importing Vue-->
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
    <script src="lessons.js"></script>
    <!--CSS styling-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" href="mystyles.css">

    <title>After School Club</title>
</head>

<body>

    <div id="app">
        <header>
            <h1>After School Club</h1>
        </header>

        <!--Switching from main page to checkout page-->
        <button @click="toggleShowProduct" v-bind:disabled="!canCheckout">
            {{totalItemsInTheCart}}
            <span class="fas fa-shopping-cart"></span>
            Checkout
        </button>



        <div v-if="showProduct" class="float_container">




            <main>

                <div v-for="lesson in sortedLessons" class="float_child">

                    <figure>
                        <img v-bind:src="lesson.image" width="100px" height="=100px">
                    </figure>

                    <h1 v-text="lesson.title"></h1>
                    <p><b>Location:</b> {{ lesson.location }}</p>
                    <p><b>Description:</b> {{ lesson.description }}</p>
                    <p><b>Price:</b> {{lesson.price}}</p>



                    <button v-on:click="addItemToCart(lesson)" v-if="canAddToCart(lesson)">
                        Add to the Cart</button>


                    <button v-else disabled>Add to the Cart</button>

                    <span v-if="classesLeft(lesson) === 0">
                        All out!</span>

                    <span v-else-if="classesLeft(lesson) < 3">
                        Only {{classesLeft(lesson)}} left!</span>

                    <span v-else>
                        Buy now!</span>

                    <div>
                        <span v-for="n in lesson.rating"> ★ </span>
                        <span v-for="n in 5 - lesson.rating"> ☆ </span>
                    </div>

                </div>
            </main>




        </div>

        <div v-else>

            <h2> Here are the lessons you have picked: </h2>


            <!-- <ul>
                    <li v-for="lesson in cart" :key="lesson.title">
                         <p v-text="lesson.title"> class at {{lesson.location}}</p> 

                        <p><b>{{lesson.title}}</b> class at <b>{{lesson.location}}</b> for <b>{{lesson.price}}</b> pounds
                        
                            <button @click="removeLesson(lesson)"> Remove </button> 
                        
                        </p>
                    </li>
                </ul> -->


            <div v-for="lesson in lessons">

                <ul v-for="(item,index) in cart">


                    <li v-if="lesson.id === item">
                        <b>{{lesson.title}}</b> class at <b>{{lesson.location}}</b> for <b>{{lesson.price}}</b> pounds

                        <button @click="removeLesson(index)"> Remove </button>

                    </li>



                </ul>

            </div>


            <p v-if="order.errors.length">
                <b>Please correct the following error(s):</b>
            <ul>
                <li v-for="error in order.errors">{{ error }}</li>
            </ul>
            </p>


            <p>
                <strong>Name:</strong>
                <input type="text" v-model.trim="order.name">
            </p>

            <p>
                <strong>Phone:</strong>
                <input type="text" v-model.trim="order.phone_number">
            </p>

            <button @click="submitCheckoutForm" v-bind:disabled="!canSubmitDetails">Place your order</button>


        </div>

    </div>

    <script>
        let webstore = new Vue({
            el: "#app",
            data: {
                //The values of the product
                sitename: "After School Club",
                showProduct: true,

                lessons: lessons,

                cart: [],



                order: {
                    errors: [],

                    name: null,
                    phone_number: null,
                },
            },
            //Functionality
            methods: {
                addItemToCart: function (lesson) {
                    this.cart.push(lesson.id);

                },
                toggleShowProduct() {
                    this.showProduct = this.showProduct ? false : true;

                },
                submitCheckoutForm() {

                    alert("Thank you for submitting your order!");

                },
                validName(name) {
                    var name_regex = /^[a-zA-Z]+$/;
                    return name_regex.test(name);


                },
                validNumber(phone_number) {
                    var phone_regex = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
                    return phone_regex.test(phone_number);


                },
                canAddToCart(lesson) {
                    return lesson.availableSpaces > this.cartCount(lesson.id);
                },
                cartCount(id) {
                    let count = 0;
                    for (let i = 0; i < this.cart.length; i++) {
                        if (this.cart[i] === id) {
                            count++;
                        }

                    }
                    return count;

                },
                classesLeft(lesson) {
                    return lesson.availableSpaces - this.cartCount(lesson.id);

                },
                removeLesson(index) {

                    this.cart.splice(index, 1);

                },
            

            },
            computed: {
                totalItemsInTheCart: function () {
                    return this.cart.length || " ";

                },
                sortedLessons() {

                    function compare(a, b) {
                        if (a.price > b.price) return -1;
                        if (a.price < b.price) return 1;
                        return 0;

                    }
                    return this.lessons.sort(compare);

                },
                canCheckout() {
                    return this.cart.length > 0;

                },
                canSubmitDetails() {
                    this.order.errors = [];

                    if (!this.order.name) {
                        //alert("Name required!")
                        this.order.errors.push('Name required.');
                    } else if (!this.validName(this.order.name)) {
                        this.order.errors.push("The name can be letters only!");

                    }
                    if (!this.order.phone_number) {
                        //alert("Phone number required!")
                        this.order.errors.push('Phone required.');
                    } else if (!this.validNumber(this.order.phone_number)) {
                        this.order.errors.push("Valid phone number required in format XXX XXX XXXX, numbers only!");

                    }
                    else {
                        return true;
                    }

                }


            }
        })

    </script>

</body>

</html>